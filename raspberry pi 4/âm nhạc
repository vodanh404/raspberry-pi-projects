import os
import time
import subprocess
import pygame
import cv2
from luma.lcd.device import st7735
from luma.core.interface.serial import spi
from luma.core.render import canvas
from PIL import ImageFont, Image
from gpiozero import Button

# --- 1. CẤU HÌNH PHẦN CỨNG ---
serial = spi(port=0, device=0, gpio_DC=24, gpio_RST=25, baudrate=40000000)
device = st7735(serial, width=128, height=160, rotate=1)

btn_up = Button(2, pull_up=True)
btn_down = Button(3, pull_up=True)
btn_select = Button(23, pull_up=True)
btn_back = Button(17, pull_up=True)

# --- 2. BIẾN HỆ THỐNG ---
menu_items = ["1. Bluetooth Setup", "2. Music Player", "3. Video Player"]
menu_index = 0
current_state = "MENU" 

# Biến Bluetooth
bt_devices = [] # Danh sách thiết bị quét được
bt_index = 0
is_scanning = False

try:
    font_s = ImageFont.truetype("DejaVuSans.ttf", 10)
    font_m = ImageFont.truetype("DejaVuSans.ttf", 12)
except:
    font_s = ImageFont.load_default()
    font_m = ImageFont.load_default()

# --- 3. LOGIC BLUETOOTH (QUAN TRỌNG) ---

def scan_bluetooth():
    """Quét các thiết bị Bluetooth xung quanh"""
    global bt_devices, is_scanning
    is_scanning = True
    draw_message("Scanning...", "Please wait 5s")
    
    bt_devices = []
    try:
        # Chạy lệnh scan trong 5 giây
        subprocess.run(["bluetoothctl", "scan", "on"], timeout=5, stdout=subprocess.DEVNULL)
        # Lấy danh sách thiết bị đã thấy
        out = subprocess.check_output(["bluetoothctl", "devices"]).decode("utf-8")
        for line in out.split('\n'):
            if "Device" in line:
                parts = line.split(' ', 2)
                if len(parts) > 2:
                    mac = parts[1]
                    name = parts[2]
                    bt_devices.append({"name": name, "mac": mac})
    except Exception as e:
        print(f"Scan error: {e}")
    
    is_scanning = False
    if not bt_devices:
        draw_message("No Devices", "Press BACK")
    else:
        draw_bt_list()

def connect_bluetooth(mac):
    """Thực hiện kết nối tới địa chỉ MAC"""
    draw_message("Connecting...", mac)
    try:
        # Trust, Pair và Connect
        subprocess.run(["bluetoothctl", "trust", mac], check=True)
        subprocess.run(["bluetoothctl", "pair", mac], timeout=10)
        res = subprocess.run(["bluetoothctl", "connect", mac], capture_output=True, text=True)
        
        if "Connection successful" in res.stdout:
            draw_message("Connected!", "Success")
        else:
            draw_message("Failed", "Try again")
    except:
        draw_message("Error", "Check device")
    time.sleep(2)
    draw_bt_list()

# --- 4. GIAO DIỆN ---

def draw_message(line1, line2):
    with canvas(device) as draw:
        draw.rectangle(device.bounding_box, outline="white", fill="black")
        draw.text((10, 50), line1, fill="yellow", font=font_m)
        draw.text((10, 80), line2, fill="white", font=font_s)

def draw_bt_list():
    with canvas(device) as draw:
        draw.rectangle(device.bounding_box, outline="white", fill="black")
        draw.text((5, 5), "SELECT DEVICE", fill="cyan", font=font_m)
        draw.line((0, 20, 160, 20), fill="white")
        
        # Hiển thị tối đa 4 thiết bị để tránh tràn màn hình
        start = max(0, bt_index - 2)
        for i, dev in enumerate(bt_devices[start:start+4]):
            idx = start + i
            color = "lime" if idx == bt_index else "white"
            prefix = "> " if idx == bt_index else "  "
            draw.text((5, 30 + i*25), f"{prefix}{dev['name'][:15]}", fill=color, font=font_s)
            draw.text((20, 42 + i*25), dev['mac'], fill="grey", font=font_s)

def draw_menu():
    with canvas(device) as draw:
        draw.rectangle(device.bounding_box, outline="white", fill="black")
        draw.text((35, 10), "MAIN MENU", fill="yellow", font=font_m)
        for i, item in enumerate(menu_items):
            color = "cyan" if i == menu_index else "white"
            draw.text((10, 45 + i*25), ("> " if i == menu_index else "  ") + item, fill=color, font=font_m)

# --- 5. XỬ LÝ NÚT BẤM ---

def move_up():
    global menu_index, bt_index
    if current_state == "MENU":
        menu_index = (menu_index - 1) % len(menu_items)
        draw_menu()
    elif current_state == "BT_SELECT" and bt_devices:
        bt_index = (bt_index - 1) % len(bt_devices)
        draw_bt_list()

def move_down():
    global menu_index, bt_index
    if current_state == "MENU":
        menu_index = (menu_index + 1) % len(menu_items)
        draw_menu()
    elif current_state == "BT_SELECT" and bt_devices:
        bt_index = (bt_index + 1) % len(bt_devices)
        draw_bt_list()

def select():
    global current_state
    if current_state == "MENU":
        if menu_index == 0:
            current_state = "BT_SELECT"
            scan_bluetooth()
        # Thêm các logic khác (Music/Video) ở đây...
        
    elif current_state == "BT_SELECT" and bt_devices:
        target_mac = bt_devices[bt_index]['mac']
        connect_bluetooth(target_mac)

def back():
    global current_state
    current_state = "MENU"
    draw_menu()

# Gán sự kiện
btn_up.when_pressed = move_up
btn_down.when_pressed = move_down
btn_select.when_pressed = select
btn_back.when_pressed = back

# Khởi động
draw_menu()

try:
    while True:
        time.sleep(0.1)
except KeyboardInterrupt:
    pass
