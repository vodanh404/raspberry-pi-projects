import sys
import subprocess
import time
import RPi.GPIO as GPIO
from luma.core.interface.serial import spi
from luma.lcd.device import st7789
from PIL import Image

# Tắt cảnh báo GPIO
GPIO.setwarnings(False)

def main():
    # --- CẤU HÌNH PHẦN CỨNG ---
    # Tốc độ SPI: 64MHz (cao nhất có thể cho ST7789)
    # Nếu màn hình bị nhiễu, hãy giảm xuống 32000000
    BAUDRATE = 64000000 
    
    try:
        serial = spi(port=0, device=0, gpio_DC=24, gpio_RST=25, baudrate=BAUDRATE)
        # rotation=0 hoặc 90 tùy theo cách bạn đặt màn hình
        device = st7789(serial, width=320, height=240, rotate=0)
        
        print(f"Khoi tao man hinh OK: {device.width}x{device.height}")

        # --- CẤU HÌNH FFMPEG (TỐI ƯU HÓA) ---
        # 1. -tune zerolatency: Giảm độ trễ khi stream
        # 2. -preset ultrafast: Ưu tiên tốc độ hơn nén (vì ta dùng rawvideo nên nén k quan trọng)
        # 3. -pix_fmt bgr24: Sửa lỗi màu Vàng/Xanh ngay từ nguồn
        ffmpeg_cmd = [
            'ffmpeg',
            '-hide_banner', '-loglevel', 'error', # Ẩn thông tin thừa, chỉ hiện lỗi
            '-f', 'fbdev',
            '-i', '/dev/fb0',
            '-vf', f'scale={device.width}:{device.height}', # Ép độ phân giải vừa khít màn hình
            '-r', '30',             # Cố gắng đạt 30 FPS
            '-f', 'image2pipe',     # Xuất ra đường ống
            '-vcodec', 'rawvideo',  # Không nén video (nhanh nhất)
            '-pix_fmt', 'bgr24',    # Đổi sang BGR để đúng màu trên ST7789
            '-tune', 'zerolatency', # Tối ưu độ trễ
            '-preset', 'ultrafast', # Tốc độ xử lý nhanh nhất
            '-'
        ]

        # Khởi chạy FFmpeg
        print("Dang chay FFmpeg... Nhan Ctrl+C de dung.")
        process = subprocess.Popen(
            ffmpeg_cmd, 
            stdout=subprocess.PIPE, 
            stderr=subprocess.PIPE,
            bufsize=10**8 # Tăng bộ nhớ đệm
        )

        # Tính toán kích thước 1 khung hình (Width * Height * 3 bytes màu)
        frame_size = device.width * device.height * 3
        
        while True:
            # Đọc dữ liệu từ FFmpeg
            raw_frame = process.stdout.read(frame_size)
            
            # Kiểm tra nếu dữ liệu đọc được không đủ 1 khung hình
            if len(raw_frame) != frame_size:
                print("Loi: Khong doc duoc du lieu frame day du.")
                # In lỗi từ FFmpeg để debug
                err = process.stderr.read()
                if err: print(f"FFmpeg Error: {err.decode('utf-8')}")
                break

            # Tạo ảnh từ bytes và hiển thị
            # Vì ta đã chỉnh bgr24 ở trên, ở đây ta load là RGB (PIL hiểu byte đầu là R, nhưng thực tế nó nhận B -> đúng màu)
            image = Image.frombytes("RGB", (device.width, device.height), raw_frame)
            
            # Đẩy ra màn hình
            device.display(image)

    except KeyboardInterrupt:
        print("\nDa dung chuong trinh.")
    except Exception as e:
        print(f"\nLoi xay ra: {e}")
    finally:
        if 'process' in locals() and process:
            process.terminate()
        GPIO.cleanup()

if __name__ == "__main__":
    main()
