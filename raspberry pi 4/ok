import subprocess
import numpy as np
import ST7789
from PIL import Image

# Cấu hình màn hình
WIDTH, HEIGHT = 240, 240
SPI_SPEED = 80000000

disp = ST7789.ST7789(
    port=0, cs=0, dc=25, rst=27, backlight=18,
    spi_speed_hz=SPI_SPEED, width=WIDTH, height=HEIGHT, rotation=90
)
disp.begin()

def play_with_ffmpeg(video_path):
    # Lệnh FFmpeg để xuất raw bytes định dạng RGB24
    command = [
        'ffmpeg',
        '-i', video_path,
        '-f', 'image2pipe',
        '-pix_fmt', 'rgb24',
        '-vcodec', 'rawvideo',
        '-vf', f'scale={WIDTH}:{HEIGHT}',
        '-' # Xuất ra stdout
    ]

    # Khởi chạy FFmpeg như một tiến trình con
    pipe = subprocess.Popen(command, stdout=subprocess.PIPE, bufsize=10**8)

    try:
        while True:
            # Đọc đúng số lượng bytes cho 1 khung hình (R, G, B mỗi màu 1 byte)
            raw_image = pipe.stdout.read(WIDTH * HEIGHT * 3)
            
            if not raw_image:
                break

            # Chuyển bytes thành ảnh và hiển thị
            image = Image.frombytes('RGB', (WIDTH, HEIGHT), raw_image)
            disp.display(image)
            
    except KeyboardInterrupt:
        print("Dừng.")
    finally:
        pipe.terminate()
        disp.set_backlight(0)

if __name__ == "__main__":
    play_with_ffmpeg('video_da_toi_uu.mp4')
