import subprocess
import os
import sys
import signal
import time
import threading
import RPi.GPIO as GPIO
from luma.lcd.device import st7789
from luma.core.interface.serial import spi
from PIL import Image

# Hardware Configuration
WIDTH = 240
HEIGHT = 320
SERIAL_SPEED = 64000000 

GPIO.setwarnings(False)

def monitor_and_kill():
    """
    A background thread that ensures no ffplay/ffmpeg remains 
    if the main thread is interrupted or closed.
    """
    main_thread = threading.main_thread()
    while True:
        # If the main script is no longer running
        if not main_thread.is_alive():
            os.system("pkill -9 ffplay")
            os.system("pkill -9 ffmpeg")
            break
        time.sleep(0.5)

def emergency_cleanup():
    """Immediate kill command"""
    os.system("pkill -9 ffplay")
    os.system("pkill -9 ffmpeg")

def initialize_device():
    try:
        serial = spi(
            port=0, 
            device=0, 
            gpio_DC=24, 
            gpio_RST=25, 
            bus_speed_hz=SERIAL_SPEED
        )
        device = st7789(
            serial, 
            width=WIDTH, 
            height=HEIGHT, 
            rotate=0
        )
        device.command(0x20) # Inversion OFF
        return device
    except Exception as e:
        print(f"Hardware initialization error: {e}")
        return None

def play_video_with_audio(video_path, device):
    if not os.path.exists(video_path) or device is None:
        print("Error: Video file not found.")
        return

    frame_size = WIDTH * HEIGHT * 3
    
    # Pre-emptive strike: kill any old sessions
    emergency_cleanup()

    # Start the monitoring thread
    monitor = threading.Thread(target=monitor_and_kill, daemon=True)
    monitor.start()

    try:
        # Start audio playback
        audio_proc = subprocess.Popen(
            ['ffplay', '-nodisp', '-autoexit', '-loglevel', 'quiet', video_path],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )

        # Start video extraction
        video_command = [
            'ffmpeg',
            '-re',
            '-i', video_path,
            '-f', 'rawvideo',
            '-pix_fmt', 'rgb24', 
            '-s', f'{WIDTH}x{HEIGHT}',
            '-loglevel', 'quiet',
            '-'
        ]
        video_pipe = subprocess.Popen(
            video_command, 
            stdout=subprocess.PIPE, 
            bufsize=frame_size
        )

        print("Playback active. Audio will stop even if forced closed.")
        
        while True:
            raw_frame = video_pipe.stdout.read(frame_size)
            if len(raw_frame) != frame_size:
                break
            
            image = Image.frombytes('RGB', (WIDTH, HEIGHT), raw_frame)
            device.display(image)

    except KeyboardInterrupt:
        print("\nExit requested.")
    finally:
        emergency_cleanup()

if __name__ == "__main__":
    # Handle system signals
    signal.signal(signal.SIGINT, lambda x, y: (emergency_cleanup(), sys.exit(0)))
    signal.signal(signal.SIGTERM, lambda x, y: (emergency_cleanup(), sys.exit(0)))

    lcd_device = initialize_device()
    if lcd_device:
        video_file = "/home/dinhphuc/Videos/test.mp4"
        try:
            play_video_with_audio(video_file, lcd_device)
        finally:
            emergency_cleanup()
